{% extends "base.html" %}
{% block title %}Agent Analysis ‚Äî {{ symbol }}{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ü§ñ Multi-Agent Analysis</h2>
    <p>4 specialist AI agents analyze any trading pair using live Binance data + Groq LLM</p>
</div>

<div class="page-body">
    <!-- Controls -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-body" style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap;">
            <div class="form-group" style="margin-bottom:0; min-width:200px;">
                <label>Trading Pair</label>
                <select class="form-control" id="symbol-select">
                    {% for sym, coin in coins.items() %}
                    <option value="{{ sym }}" {{ 'selected' if sym==symbol }}>{{ coin.icon }} {{ coin.short }}/USDT ‚Äî {{
                        coin.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom:0; min-width:160px;">
                <label>Horizon</label>
                <select class="form-control" id="horizon-select">
                    <option value="5" selected>5 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                </select>
            </div>
            <button class="btn btn-primary" id="analyze-btn" onclick="runAnalysis()">
                <i data-lucide="play" style="width:16px;height:16px;"></i> Run Analysis
            </button>
        </div>
    </div>

    <!-- Agent Pipeline -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h3><i data-lucide="workflow" style="width:16px;height:16px;"></i> Agent Pipeline</h3>
            <span class="badge badge-blue" id="pipeline-status">Ready</span>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                <div class="pipeline-stage stage-agent" id="stage-market" style="flex:1; min-width:180px;">
                    <div class="stage-icon">üìà</div>
                    <div>
                        <h4>MarketAnalyst</h4>
                        <p>Technical indicator analysis</p>
                    </div>
                </div>
                <div class="pipeline-arrow" style="align-self:center;">‚Üí</div>
                <div class="pipeline-stage stage-agent" id="stage-sentiment" style="flex:1; min-width:180px;">
                    <div class="stage-icon">üí¨</div>
                    <div>
                        <h4>SentimentAnalyst</h4>
                        <p>News sentiment reasoning</p>
                    </div>
                </div>
                <div class="pipeline-arrow" style="align-self:center;">‚Üí</div>
                <div class="pipeline-stage stage-agent" id="stage-risk" style="flex:1; min-width:180px;">
                    <div class="stage-icon">üõ°Ô∏è</div>
                    <div>
                        <h4>RiskManager</h4>
                        <p>Anomaly & risk scoring</p>
                    </div>
                </div>
                <div class="pipeline-arrow" style="align-self:center;">‚Üí</div>
                <div class="pipeline-stage stage-agent" id="stage-portfolio" style="flex:1; min-width:180px;">
                    <div class="stage-icon">üéØ</div>
                    <div>
                        <h4>PortfolioStrategist</h4>
                        <p>Signal fusion & recommendation</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="grid grid-2" id="results-area" style="display: none;">
        <!-- Recommendation -->
        <div class="recommendation-card" id="recommendation-card" style="grid-column: 1 / -1;">
            <div class="recommendation-header hold" id="rec-header">
                <div>
                    <div class="recommendation-action" id="rec-action">‚Äî</div>
                    <div style="font-size:13px; color: var(--text-secondary); margin-top:4px;" id="rec-symbol">‚Äî</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size:13px; color: var(--text-muted);">Confidence</div>
                    <div style="font-size:28px; font-weight:800; font-family:'JetBrains Mono';" id="rec-confidence">‚Äî
                    </div>
                </div>
            </div>
            <div class="recommendation-body">
                <pre id="rec-text">‚Äî</pre>
            </div>
        </div>

        <!-- Agent Trace -->
        <div class="card">
            <div class="card-header">
                <h3><i data-lucide="list-checks" style="width:16px;height:16px;"></i> Agent Trace</h3>
            </div>
            <div class="card-body" id="agent-trace">
                <div class="empty-state">
                    <div class="icon">ü§ñ</div>
                    <h3>No trace yet</h3>
                    <p>Run an analysis to see the agent pipeline in action</p>
                </div>
            </div>
        </div>

        <!-- Prediction Details -->
        <div class="card">
            <div class="card-header">
                <h3><i data-lucide="target" style="width:16px;height:16px;"></i> Prediction</h3>
            </div>
            <div class="card-body">
                <div id="prediction-details">
                    <div class="model-card">
                        <div class="field">
                            <div class="field-label">Direction</div>
                            <div class="field-value" id="pred-direction">‚Äî</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Confidence</div>
                            <div class="field-value" id="pred-confidence">‚Äî</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Model</div>
                            <div class="field-value" id="pred-model">‚Äî</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Latency</div>
                            <div class="field-value" id="pred-latency">‚Äî</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <div class="field-label" style="margin-bottom: 8px; font-size:11px; color:var(--text-muted);">
                            PROBABILITY DISTRIBUTION</div>
                        <canvas id="prob-chart" height="120"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Initial empty state -->
    <div id="empty-state" class="card">
        <div class="empty-state">
            <div class="icon">üß†</div>
            <h3>Select a trading pair and run analysis</h3>
            <p>The 4-agent pipeline will fetch live Binance data, run technical & sentiment analysis through Groq, and
                produce a trading recommendation.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-run if a symbol is set
    {% if symbol %}
    // Ready state ‚Äî user clicks "Run Analysis"
    {% endif %}
</script>
{% endblock %}